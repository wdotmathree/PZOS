#include <kernel/kbd.h>

#include <kernel/log.h>
#include <kernel/ps2.h>

// clang-format off
static uint8_t normal_map[256] = {
	0xff,0xa9,0xff,0xa5,0xa3,0xa1,0xa2,0xac,0xff,0xaa,0xa8,0xa6,0xa4,0x60,0x80,0xff,
	0xff,0x02,0x20,0xff,0x00,0x61,0x81,0xff,0xff,0xff,0x21,0x42,0x41,0x62,0x82,0xff,
	0xff,0x23,0x22,0x43,0x63,0x84,0x83,0xff,0xff,0x03,0x24,0x44,0x65,0x64,0x85,0xff,
	0xff,0x26,0x25,0x46,0x45,0x66,0x86,0xff,0xff,0xff,0x27,0x47,0x67,0x87,0x88,0xff,
	0xff,0x28,0x48,0x68,0x69,0x8a,0x89,0xff,0xff,0x29,0x2a,0x49,0x4a,0x6a,0x8b,0xff,
	0xff,0xff,0x4b,0xff,0x6b,0x8c,0xff,0xff,0x40,0x2b,0x4c,0x6c,0xff,0x6d,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0x8d,0xff,0xff,0x31,0xff,0x51,0x71,0xff,0xff,0xff,
	0x11,0x13,0x32,0x52,0x53,0x72,0xa0,0x91,0xab,0x54,0x33,0x94,0x93,0x73,0xaf,0xff,
	0xff,0xff,0xff,0xa7,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
};

static uint8_t extended_map[256] = {
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xe2,0x04,0xae,0xff,0x07,0xc6,0xff,0xff,0xe1,0xff,0xff,0xff,0xff,0xff,0xff,0x01,
	0xe7,0xc2,0xff,0xc4,0xff,0xff,0xff,0x05,0xe5,0xff,0xff,0xcc,0xff,0xff,0xff,0x06,
	0xe6,0xff,0xc3,0xff,0xc7,0xff,0xff,0xee,0xe8,0xff,0xca,0xc5,0xff,0xff,0xff,0xef,
	0xe0,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc9,0xff,0x92,0xff,0xff,0xc8,0xff,0xff,
	0xc1,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x14,0xff,0xff,0xff,0xf1,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x6f,0xff,0x0e,0x8f,0xff,0xff,0xff,
	0x8e,0x6e,0x0f,0xff,0x10,0x2f,0xff,0xb0,0xff,0xff,0x70,0xff,0xae,0x90,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
};
// clang-format on

static char rbuf[256];
static uint8_t rbuf_ridx = 0;
static uint8_t rbuf_widx = 0;

static char wbuf[256];
static uint8_t wbuf_ridx = 0;
static uint8_t wbuf_widx = 0;
static uint8_t retry_cnt = 0;

static bool active = false;

typedef enum {
	STATE_NORMAL = 0,
	STATE_EXTENDED = 1 << 0,
	STATE_BREAK = 1 << 1,
	STATE_DIGRAPH = 1 << 2,
	STATE_TWOBYTE = 1 << 3,
} state_t;

static state_t current_state = STATE_NORMAL;
static uint16_t prev = 0xffff;

static isr_frame_t *kbd_isr(isr_frame_t *const frame) {
	uint8_t scancode = ps2_read_data();

	if (scancode == 0xfa) {
		if (++wbuf_ridx != wbuf_widx)
			ps2_send_kbd(wbuf[wbuf_ridx]);
		return frame;
	} else if (scancode == 0xfe) {
		if (retry_cnt < 3) {
			retry_cnt++;
			LOG("KBD", "Resending last byte, attempt %d", retry_cnt);
			ps2_send_kbd(wbuf[wbuf_ridx]);
		} else {
			LOG("KBD", "Failed to send last byte after 3 attempts");
			retry_cnt = 0;
		}
		return frame;
	}
	if (!active)
		return frame;

	// Begin parsing scancode sequences
	if (scancode == 0xe0) {
		current_state |= STATE_EXTENDED;
	} else if (scancode == 0xf0) {
		current_state |= STATE_BREAK;
	} else if (scancode == 0xe1) {
		current_state |= STATE_TWOBYTE;
	} else {
		uint8_t key = 0xff;

		if ((current_state & STATE_EXTENDED) && (scancode == 0x12 || scancode == 0x7c) && !(current_state & STATE_DIGRAPH)) {
			current_state |= STATE_DIGRAPH;
			return frame;
		} else if (current_state & STATE_TWOBYTE) {
			if (prev == 0xffff) {
				prev = scancode;
				return frame;
			}

			prev = 0xffff;
			// Currently we can just ignore the top byte
			key = extended_map[scancode];
		} else if (current_state & STATE_EXTENDED) {
			key = extended_map[scancode];
		} else {
			key = normal_map[scancode];
		}

		if (current_state & STATE_BREAK)
			LOG("KBD", "Key released: 0x%02x", key);
		else
			LOG("KBD", "Key pressed: 0x%02x", key);
		current_state = STATE_NORMAL;
	}

	return frame;
}

static int kbd_read(void) {
	if (rbuf_widx == rbuf_ridx)
		return -1;
	return rbuf[rbuf_ridx++];
}

static void kbd_write(char c) {
	wbuf[wbuf_widx] = c;
	if (wbuf_widx++ == wbuf_ridx)
		ps2_send_kbd(c);
}

void kbd_init(void) {
	if (!ps2_init())
		return;

	ps2_register_kbd_isr(kbd_isr);

	kbd_write(0xf0);
	kbd_write(0x02);

	kbd_write(0xf4);
	active = true;
}
